# TCP，IP协议族之数字签名与HTTPS详解

- [前言](#前言)
- [RSA和AES简述](#rsa和aes简述)
    - [RSA公钥加密算法](#rsa公钥加密算法)
    - [AES高级加密标准](#aes高级加密标准)
- [CA证书](#ca证书)
- [HTTPS安全通信机制的建立](#https安全通信机制的建立)
    - [HTTPS简介](#https简介)
    - [HTTPS的通信过程](#https的通信过程)

----------------

## 前言

因为HTTP协议本身存在明文传输，不能很好的验证通信方的身份和无法验证报文的完整性。HTTPS确切的说不是一种协议而是HTTP+SSL(TSL)的结合体。HTTP报文经过SSL层加密后交付给TCP层进行传输。SSL(安全套接层)主要采用的是RSA(非对称加密)与AES(对称加密)结合的加密方式。

先通过RSA加密交互AES的密钥，然后通过AES进行报文的加密和解密。

## RSA和AES简述

### RSA公钥加密算法

RSA就是该算法的三位发明者的名字的首字母的组合。RSA是非对称加密算法，其在加密和加密的过程中需要，两个Key，一个公钥（public key），一个私钥（private key）。公钥负责加密，私钥负责解密。

从名字可以看出公钥是可以开放出去的，任何人都可以持有公钥进行加密。而私钥必须的进行保护，因为是用来解密的。

这样一来对于加密和解密就可以使用不同的钥匙来处理。对于加密方来说，即使你可以对报文进行加密，如果没有私钥的话也是不可以对你加密的内容进行解密的。

举例：这就相当于一个存钱罐一样，你可以把钱放进去，但是如果你没有钥匙的话，也是没有打开存钱罐的从而也拿不到存钱罐里的钱

插图：RSA(非对称加密算法)

![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/RSA.png)

### AES高级加密标准

AES，全称：Advanced Encryption Standard----高级加密算法标准。该加密算法只有一个密钥，该密钥可以用来加密，也可以用来解密，所以AES是对称加密算法。

下方这个就是AES的加密和解密的过程。Client端和Server端有一个共同的Key，这个Key是用来进行加密和解密的。如果报文在传输过程中被窃取了，没有这个key，对加密的内容进行破解是非常困难的，当然窃取者如果有key的话，也是可以轻而易举的解密的。所以AES中，key是关键。

举例：这也就相当于家中的钥匙一样，谁拿到钥匙都可以打开家中的门，即使门锁在安全，在钥匙面前也是不行的。如果不知道家在哪里，拿到钥匙也没有用。家的位置就相当于是数据，钥匙就是对于数据解密的key。

所以对于AES加密策略来说这个这个Key的保密措施要做足一些。比如每次加密的Key都是从密码本中动态生成的，而这个密码本服务端和客户端都有同一本，每次传输的是一些参数。这些参数在经过一些算法的映射，从密码本中取出相应的Key用来解密。这样一来就相当于给AES加了一层防盗门，加大了破解的难度。这样做的好处是每次加密的key都是不同的，而且需要密码本和加密算法的支持。

插图：AES(对称加密算法)

![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/AES.png)

## CA证书

如果你自己通过RSA算法生成了一个私钥和公钥，在公钥发送给客户端的过程中有可能被篡改成其他的公钥，而客户端在没有其他措施的保护下是不知道该公钥是否就是服务器那边的私钥对应的公钥。这种自己做的RSA的私钥和公钥在有可能进行公钥分发的过程中被篡改。

下方就是Client从Server获取公钥是被中间者篡改了，将public key换成了自己的伪public key，同样这个中间者持有伪private key。如果客户端使用伪public key进行加密传输的话，就会被中间者使用自己的伪private key进行解密，从而获取到发送的数据。

举例：假设你在古代，你出门在外，妻子在家养子。你们家有个箱子，箱子上有把锁，这就是你和你妻子互通的工具。你媳妇儿负责往箱子里放东西，然后上锁。你有把独特的钥匙，你负责开锁，取东西。可是你再将箱子给镖局托运的的过程中，被镖局的“小黑”掉包了，箱子的外表一致，锁看起来也一样，可是已经不是你的箱子了。因为路途遥远，古代又没有什么iPhone啥的，你媳妇没办法来辨别该箱子是否是原装的。然后就将一些东西放在了箱子里边，然后上锁交给了镖局的“小黑”。

因为“小黑”掉包的箱子，所以小黑有箱子的钥匙呢，然后就可以打开这个箱子，取东西了。原来的箱子又在小黑那，小黑就可以往原来的箱子里边随便往箱子放点没有价值的东西给你就行了。当你发现箱子里的东西不是你想要的时候，完了，小黑从镖局辞职了，找不到人了。找镖局的人讨说法，可是镖局的人说“小黑”是镖局的临时工，这个责任镖局说了，我们不能担。鉴于你无权无势，这事儿也就此罢了。（故事纯属虚构，如有雷同纯属巧合）

插图：伪公钥

![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/public%20key.png)

为了防止“小黑”再次作案，所以颁布一个公正机构来证明你媳妇收到的箱子就是你发出的箱子。在RAS加密中也有一个第三方机构来充当这个角色，负责证明客户端收到的证书就是你发送的证书，中间没有被篡改。这个中间认证机构，就是数组证书认证机构, 其颁发的证书也就是我们常说的CA证书（CA , Certificate Authority）。 

下面我们就来详细的叙述一下证书签名，证书分发以及证书验证的整个过程。

- 1、服务端人员使用RSA算法生成两个密钥，一个用来加密一个用来解密。将负责加密的那个密钥公布出去，所以我们称之为公钥（Public Key），而用来解密的那个密钥，不能对外公布，只有服务端持有，所以我们称之为私钥（Private Key）。服务端在将Public Key进行分发证书之前需要向CA机构申请给将要分发的公钥进行数字签名。（服务器公钥负责加密，服务器私钥负责解密）
- 2、生成数字签名公钥证书：对于CA机构来说，其也有两个密钥，我们暂且称之为CA私钥和CA公钥。CA机构将服务端的Public Key作为输入参数将其转换为一个特有的Hash值。然后使用CA私钥将这个Hash值进行加密处理，并与服务端的Public Key绑定在一起，生成数字签名证书。其实数字签名证书的本质就是服务端的公钥+CA私钥加密的Hash值。（CA私钥负责签名，CA公钥负责验证）
- 3、服务器获取到这个已经含有数字签名并带有公钥的证书，将该证书发送给客户端。当客户端收到该公钥数字证书后，会验证其有效性。大部分客户端都会预装CA机构的公钥，也就是CA公钥。客户端使用CA公钥对数字证书上的签名进行验证，这个验证的过程就是使用CA公钥对CA私钥加密的内容进行解密，将解密后的内容与服务端的Public Key所生成的Hash值进行匹配，如果匹配成功，则说明该证书就是相应的服务端发过来的。否则就是非法证书。
- 4、验证完服务端公钥的合法性后，就可以使用该公钥进行加密通信了。

**如何生成数字证书**

首先将**服务器的一些信息以及public key**通过hash函数进行映射，形成**信息摘要**，然后再到CA机构将这个**信息摘要使用CA机构的private key进行hash形成数字签名**，最后将**数字签名和服务器的一些信息以及服务器的public key结合在一起形成数字证书。**

**数字证书=数字签名+(服务器信息+public key)**

![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E7%94%9F%E6%88%90.png)

当客户端拿到数字证书之后，就会用CA提供的公钥来对数字证书里面的数字签名进行解密来得到信息摘要，然后对数字证书里服务器的公钥以及个人信息进行Hash得到另外一份信息摘要。最后把两份信息摘要进行对比，如果一样，则证明这个是服务器，否则就不是。如图：

![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E8%A7%A3%E5%AF%86.png)



下方这个截图就是苹果的根证书的一些信息，从下方可以看出，CA证书内容中包括加密算法，公共密钥以及数字签名。

插图：苹果证书

![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/CA%E8%AF%81%E4%B9%A6.jpg)

下方就是公钥以及数字签名的具体内容，当对下方公共密钥进行验证时，需要使用内置的CA公钥将数字签名进行解密。然后将解密后的内容，与公钥生成的Hash值进行比较，如果匹配成功，那么该证书就是CA机构颁布的合法证书。

插图：数字签名和信息摘要

![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/%E5%85%AC%E9%92%A5%E4%B8%8E%E7%AD%BE%E5%90%8D.jpg)

## HTTPS安全通信机制的建立

上面我们聊完AES与RSA加密策略，然后又聊了带有数字签名的公共密钥。上面这两部分内容都是为HTTPS做铺垫的，接下来就看一看HTTP+SSL是如何进行数据传输的。

### HTTPS简介

在开头的部分也说了，HTTPS不是一个新的通信协议，而是HTTP与SSL（或TSL）的组合。SSL--安全套节层(Secure Socket Layer), TSL（Transport Layer Security 安全传输层）是以SSL为原型开发的协议，IETF以SSL3.0为基准后又制定了TLS1.0、TLS1.1和TLS1.2，当前主流版本为SSL3.0与TLS1.0。

HTTPS就是在HTTP与TCP层中间添加了一个SSL层。因为HTTPS被HTTP多了这层加密的流程，所以HTTPS的速度要比HTTP慢的多。

![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/SSL.jpg)

### HTTPS的通信过程

SSL的加密过程是RSA与AES混合进行的。简单概括一下，就是通过RSA加密方式来交换AES加解密的密钥，然后使用AES加密的方式来传输报文。下方是SSL建立连接以及传输数据的图解。在下图中大体可以分为四步：

- 第一步：有客户端发起的第一次握手，此次握手过程的主要目的是从服务端获取数字签名证书，服务端在发送数字签名证书之前要先确认客户端的SSL版本、加密算法等信息。

- 第二步：完成第一次握手后，接着进行第二次握手。第二次握手是在客户端收到证书后发起的，主要目的是将AES加解密使用的Key （Pre-master secret）发送给服务端。当然这个AESKEY是使用第一次握手获取的公钥进行加密的。客户端收到这个使用公钥加密后的AESKEY，使用服务端的私钥进行解密。这样客户端和服务端经过二次握手后都持有了AES加解密的KEY。

- 第三步：当Client与Server端都持有AES_KEY后，就可以对HTTP报文进行加解密了。

- END: 最后就是断开连接了。具体如下图所示：

  ![](https://ykitty.oss-cn-beijing.aliyuncs.com/photo/https%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B.jpg)