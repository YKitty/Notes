# 乐观锁和悲观锁

---------------------

## 1. 并发控制

在**多线程环境下，为了保证线程安全，需要使用并发控制。**

数据库管理系统中有**事务**的概念，它是**一组操作**，并且满足**ACID特性**。一个事务可以看成一组**任务**，而任务是由**线程驱动**的，因此事务也可以并发的执行。并发执行多个事务时，为了保证每个事物都具有ACID特性，也同样需要**并发控制**。

常见的由并发所产生的问题：

- **脏读：** 当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，此时，另外一个事务也访问这个数据，然后使用了这个数据

- **不可重复读：**是指在一个事务内，多次读同一个数据。在这个事务还没有结束时，另外一个事务也访问同一个数据。那么，在第一个事务两次读取数据之间，另外一个事务的修改，那么第一个事务两次读到的数据可能是不一样的。

- **幻读：**指当事务不是独立执行时发生的一种现象（一般是对于整个表进行了修改）。

  例如：第一个事务对一个表的所有id进行了修改，同时第二个事务也向这个表中插入一行新数据。那么以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就像发生了幻觉一样。

为了解决并发带来的问题。我们引入了**并发控制**。

主要有两种并发控制方法：**悲观并发控制和乐观并发控制**。

## 2. 并发控制机制

**悲观锁：**假定每次操作时，都会发生并发冲突，每次进行操作时，都会申请锁

**乐观锁：**假定每次操作时，都不会发生冲突，直接进行操作，操作完成之后进行冲突检测，发生冲突，则申请锁重新操作，否则操作成功。

**【注意】：乐观锁不能解决脏读问题**

原因：对于乐观锁操作完成之后，会进行冲突检测，但是这个时候第二事务有可能还没有对于数据进行操作（回滚），所以就无法检测到

## 3. 悲观并发控制

悲观并发控制保持悲观的态度，认为并发执行过程中一定会出现问题，一定要对数据进行保护，不能同时两个事物对一个数据进行操作。